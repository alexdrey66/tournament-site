<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AYSO Area 10W – Tournament Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 60%);
      color: #e5e7eb;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      margin-bottom: 16px;
    }

    .eyebrow {
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    h1 {
      margin: 4px 0;
      font-size: 1.7rem;
      color: #fef9c3;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .tagline {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #64748b;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: 14px;
      border: 1px solid #1f2937;
      background:
        radial-gradient(circle at top left, rgba(59,130,246,0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.12), transparent 60%),
        #020617;
      padding: 10px 12px 12px;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.5);
    }

    .panel h2 {
      margin: 0 0 4px;
      font-size: 1rem;
      color: #e5e7eb;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .panel h3 {
      margin: 6px 0 4px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1 1 120px;
      min-width: 120px;
    }

    label {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select {
      border-radius: 9px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      background: linear-gradient(to right, #3b82f6, #22c55e);
      color: #0b1120;
      font-weight: 500;
      white-space: nowrap;
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    button.danger {
      background: rgba(185, 28, 28, 0.95);
      color: #fee2e2;
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
    }

    ul.list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 210px;
      overflow-y: auto;
    }

    .pool-item,
    .team-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #111827;
      font-size: 0.8rem;
      gap: 8px;
    }

    .pool-name,
    .team-name {
      color: #e5e7eb;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .team-penalty {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .team-penalty input {
      width: 52px;
    }

    .games-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow-y: auto;
    }

    .game-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.8fr) auto;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #111827;
      font-size: 0.8rem;
      align-items: center;
    }

    @media (max-width: 800px) {
      .game-row {
        grid-template-columns: minmax(0, 1.5fr) minmax(0, 0.9fr);
        grid-template-rows: auto auto;
      }

      .game-row .game-actions {
        grid-column: 1 / -1;
        justify-content: flex-end;
      }
    }

    .game-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .game-meta {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .game-teams {
      font-weight: 500;
      color: #e5e7eb;
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
    }

    .game-scores {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
    }

    .game-scores input {
      width: 52px;
      text-align: center;
    }

    .game-actions {
      display: flex;
      justify-content: flex-end;
    }

    .small-muted {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .login-card {
      max-width: 360px;
      margin: 60px auto;
      padding: 16px 18px 18px;
      border-radius: 14px;
      border: 1px solid #1f2937;
      background:
        radial-gradient(circle at top left, rgba(59,130,246,0.16), transparent 60%),
        #020617;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.5);
    }

    .login-title {
      margin: 0 0 8px;
      font-size: 1.1rem;
      color: #fef9c3;
    }

    .login-sub {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .login-error {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #fecaca;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      margin-top: 4px;
    }

    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .toolbar-label {
      font-size: 0.75rem;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="page" style="display: none;">
    <div class="login-card">
      <p class="eyebrow">Tournament Admin</p>
      <h1 class="login-title">Sign in</h1>
      <p class="login-sub">
        This page is for tournament staff only. Enter the admin password to manage
        pools, teams, and scores.
      </p>
      <div class="field">
        <label for="admin-password">Admin password</label>
        <input type="password" id="admin-password" autocomplete="off" />
      </div>
      <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 8px; align-items: center;">
        <span id="login-error" class="login-error"></span>
        <button type="button" onclick="handleLogin()">Unlock</button>
      </div>
    </div>
  </div>

  <!-- MAIN ADMIN UI -->
  <div id="tournament-admin" class="page" style="display: none;">
    <header>
      <div class="eyebrow">AYSO Area 10W League Tournament</div>
      <h1>Tournament Admin</h1>
      <p class="subtitle">Manage divisions, pools, teams, and scores. Changes update all public standings pages.</p>
      <p class="tagline">
        Scoring: Win 6 pts · Tie 3 pts · Goals 1 pt (max 3) · Shutout +1 pt · Penalties subtract from total.
      </p>

      <div class="toolbar">
        <div class="toolbar-left">
          <span class="toolbar-label">Working in division:</span>
          <select id="ta-division"></select>
        </div>
        <div class="toolbar-right">
          <button type="button" class="secondary" onclick="lockAdmin()">Lock admin</button>
          <button type="button" class="danger" onclick="taClearAll()">Clear ALL data</button>
        </div>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Pools + teams -->
      <section class="panel">
        <h2>
          Pools &amp; Teams
          <span class="badge">Structure</span>
        </h2>

        <!-- Pools -->
        <h3>Pools in this division</h3>
        <div class="field-row">
          <div class="field">
            <label for="ta-pool-name">New pool name</label>
            <input id="ta-pool-name" type="text" placeholder="e.g., Pool A" />
          </div>
          <button type="button" onclick="taAddPool()">Add pool</button>
        </div>
        <ul id="ta-pool-list" class="list"></ul>

        <hr style="border:none; border-top:1px solid #111827; margin:10px 0;" />

        <!-- Teams -->
        <h3>Teams</h3>
        <div class="field-row">
          <div class="field">
            <label for="ta-team-pool">Pool</label>
            <select id="ta-team-pool"></select>
          </div>
          <div class="field">
            <label for="ta-team-name">New team name</label>
            <input id="ta-team-name" type="text" placeholder="e.g., 14U B #1" />
          </div>
          <button type="button" onclick="taAddTeam()">Add team</button>
        </div>
        <ul id="ta-team-list" class="list"></ul>
      </section>

      <!-- RIGHT: Games -->
      <section class="panel">
        <h2>
          Games &amp; Scores
          <span class="badge">Results</span>
        </h2>

        <h3>Create game</h3>
        <div class="field-row">
          <div class="field">
            <label for="ta-game-pool">Pool</label>
            <select id="ta-game-pool"></select>
          </div>
          <div class="field">
            <label for="ta-game-datetime">Date &amp; time</label>
            <input id="ta-game-datetime" type="datetime-local" />
          </div>
          <div class="field">
            <label for="ta-game-field">Field</label>
            <input id="ta-game-field" type="text" placeholder="e.g., Field 1" />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="ta-game-teamA">Home team</label>
            <select id="ta-game-teamA"></select>
          </div>
          <div class="field">
            <label for="ta-game-teamB">Away team</label>
            <select id="ta-game-teamB"></select>
          </div>
          <button type="button" onclick="taAddGame()">Add game</button>
        </div>

        <p class="small-muted" style="margin-top: 4px;">
          Scores and penalties update standings immediately on the public pages.
          Date/time and field stay in the form so you can quickly add multiple games in the same slot.
        </p>

        <h3 style="margin-top: 10px;">Games in selected pool</h3>
        <div id="ta-games-list" class="games-list"></div>
      </section>
    </div>
  </div>

  <script>
    /* ---- CONFIG ---- */
    const API_URL = "https://script.google.com/macros/s/AKfycbzxMdFv4Ztw-4ZoXI-m-AJGKK2ops8ZBs-uhLLVpecEeMy628wnn5vssVC17Z87kTfLow/exec";
    const ADMIN_PASSWORD = "PLAYSOCCER";
    const ADMIN_UNLOCK_KEY = "tournament_admin_unlocked_v1";

    /* ---- STATE ---- */
    let taState = {
      pools: [],   // {id, name, divisionId}
      teams: [],   // {id, name, poolId, penalty}
      games: []    // {id, poolId, teamAId, teamBId, dateTime, field, scoreA, scoreB}
    };

    const TA_DIVISIONS = [
      { id: "14u-boys",  name: "14U Boys"  },
      { id: "14u-girls", name: "14U Girls" },
      { id: "12u-boys",  name: "12U Boys"  },
      { id: "12u-girls", name: "12U Girls" },
      { id: "10u-boys",  name: "10U Boys"  },
      { id: "10u-girls", name: "10U Girls" }
    ];

    /* ---- LOGIN ---- */
    function showAdminUI() {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("tournament-admin").style.display = "block";
    }

    function handleLogin() {
      const input = document.getElementById("admin-password");
      const error = document.getElementById("login-error");
      const value = (input.value || "").trim();

      if (!value) {
        error.textContent = "Please enter the password.";
        return;
      }

      if (value === ADMIN_PASSWORD) {
        localStorage.setItem(ADMIN_UNLOCK_KEY, "true");
        input.value = "";
        error.textContent = "";
        showAdminUI();
      } else {
        error.textContent = "Incorrect password. Please try again.";
      }
    }

    function lockAdmin() {
      localStorage.removeItem(ADMIN_UNLOCK_KEY);
      document.getElementById("tournament-admin").style.display = "none";
      document.getElementById("login-screen").style.display = "block";
      document.getElementById("admin-password").value = "";
      document.getElementById("login-error").textContent = "";
    }

    /* ---- BACKEND STORAGE (Apps Script) ---- */
    async function taLoadState() {
      try {
        const res = await fetch(API_URL + "?action=get", {
          method: "GET",
          headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (data && data.pools && data.teams && data.games) {
          taState = data;
        } else {
          taState = { pools: [], teams: [], games: [] };
        }
      } catch (err) {
        console.error("Failed to load state from server", err);
        taState = { pools: [], teams: [], games: [] };
      }
    }

    function taSaveState() {
      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(taState)
      }).catch(err => {
        console.error("Failed to save state to server", err);
      });
    }

    /* ---- DIVISIONS ---- */
    function taInitDivisionSelect() {
      const sel = document.getElementById("ta-division");
      sel.innerHTML = "";
      TA_DIVISIONS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        if (i === 0) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.addEventListener("change", () => {
        taRenderPools();
        taSyncPoolSelectors();
        taRenderTeams();
        taRenderGames();
      });
    }

    function taCurrentDivisionId() {
      const sel = document.getElementById("ta-division");
      return sel.value;
    }

    /* ---- POOLS ---- */
    function taAddPool() {
      const nameInput = document.getElementById("ta-pool-name");
      const name = nameInput.value.trim();
      if (!name) return;

      const divisionId = taCurrentDivisionId();
      const id = "pool-" + Date.now() + "-" + Math.random().toString(36).slice(2, 7);
      taState.pools.push({ id, name, divisionId });
      taSaveState();
      nameInput.value = "";
      taRenderPools();
      taSyncPoolSelectors();
    }

    function taDeletePool(id) {
      taState.games = taState.games.filter(g => g.poolId !== id);
      taState.teams = taState.teams.filter(t => t.poolId !== id);
      taState.pools = taState.pools.filter(p => p.id !== id);
      taSaveState();
      taRenderPools();
      taSyncPoolSelectors();
      taRenderTeams();
      taRenderGames();
    }

    function taRenderPools() {
      const ul = document.getElementById("ta-pool-list");
      ul.innerHTML = "";
      const divId = taCurrentDivisionId();
      const pools = taState.pools.filter(p => p.divisionId === divId);

      if (pools.length === 0) {
        const li = document.createElement("li");
        li.className = "small-muted";
        li.textContent = "No pools for this division yet.";
        ul.appendChild(li);
        return;
      }

      pools.forEach(p => {
        const li = document.createElement("li");
        li.className = "pool-item";
        li.innerHTML = `
          <span class="pool-name">${p.name}</span>
          <div class="item-actions">
            <button type="button" class="secondary" onclick="taDeletePool('${p.id}')">Delete</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    function taSyncPoolSelectors() {
      const divId = taCurrentDivisionId();
      const pools = taState.pools.filter(p => p.divisionId === divId);

      const teamPoolSel = document.getElementById("ta-team-pool");
      const gamePoolSel = document.getElementById("ta-game-pool");

      [teamPoolSel, gamePoolSel].forEach(sel => {
        sel.innerHTML = "";
        pools.forEach((p, i) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          if (i === 0) opt.selected = true;
          sel.appendChild(opt);
        });
      });

      taSyncGameTeamSelectors();
    }

    /* ---- TEAMS ---- */
    function taAddTeam() {
      const poolId = document.getElementById("ta-team-pool").value;
      if (!poolId) return;

      const nameInput = document.getElementById("ta-team-name");
      const name = nameInput.value.trim();
      if (!name) return;

      const id = "team-" + Date.now() + "-" + Math.random().toString(36).slice(2, 7);
      taState.teams.push({ id, name, poolId, penalty: 0 });
      taSaveState();
      nameInput.value = "";
      taRenderTeams();
      taSyncGameTeamSelectors();
    }

    function taDeleteTeam(id) {
      taState.games = taState.games.filter(g => g.teamAId !== id && g.teamBId !== id);
      taState.teams = taState.teams.filter(t => t.id !== id);
      taSaveState();
      taRenderTeams();
      taRenderGames();
      taSyncGameTeamSelectors();
    }

    function taUpdateTeamPenalty(teamId, value) {
      const t = taState.teams.find(t => t.id === teamId);
      if (!t) return;
      const num = value === "" ? 0 : Number(value);
      if (Number.isNaN(num) || num < 0) return;
      t.penalty = num;
      taSaveState();
    }

    function taRenderTeams() {
      const ul = document.getElementById("ta-team-list");
      ul.innerHTML = "";
      const poolId = document.getElementById("ta-team-pool").value;
      if (!poolId) {
        const li = document.createElement("li");
        li.className = "small-muted";
        li.textContent = "Create a pool first.";
        ul.appendChild(li);
        return;
      }

      const teams = taState.teams.filter(t => t.poolId === poolId);
      if (teams.length === 0) {
        const li = document.createElement("li");
        li.className = "small-muted";
        li.textContent = "No teams in this pool yet.";
        ul.appendChild(li);
        return;
      }

      teams.forEach(t => {
        const penalty = t.penalty ? Number(t.penalty) : 0;
        const li = document.createElement("li");
        li.className = "team-item";
        li.innerHTML = `
          <span class="team-name">${t.name}</span>
          <div class="item-actions">
            <div class="team-penalty">
              <span>Penalty</span>
              <input type="number" min="0" step="1"
                value="${penalty}"
                onchange="taUpdateTeamPenalty('${t.id}', this.value)" />
            </div>
            <button type="button" class="secondary" onclick="taDeleteTeam('${t.id}')">Delete</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    /* ---- GAMES ---- */
    function taSyncGameTeamSelectors() {
      const poolId = document.getElementById("ta-game-pool").value;
      const teams = taState.teams.filter(t => t.poolId === poolId);

      const selA = document.getElementById("ta-game-teamA");
      const selB = document.getElementById("ta-game-teamB");
      [selA, selB].forEach(sel => {
        sel.innerHTML = "";
        teams.forEach((t, i) => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.name;
          if (i === 0) opt.selected = true;
          sel.appendChild(opt);
        });
      });
    }

    function taAddGame() {
      const poolId = document.getElementById("ta-game-pool").value;
      const teamAId = document.getElementById("ta-game-teamA").value;
      const teamBId = document.getElementById("ta-game-teamB").value;
      const dateTime = document.getElementById("ta-game-datetime").value || "";
      const field = document.getElementById("ta-game-field").value.trim();

      if (!poolId || !teamAId || !teamBId || teamAId === teamBId) return;

      const id = "game-" + Date.now() + "-" + Math.random().toString(36).slice(2, 7);
      taState.games.push({
        id,
        poolId,
        teamAId,
        teamBId,
        dateTime: dateTime || null,
        field: field || null,
        scoreA: null,
        scoreB: null
      });
      taSaveState();

      // Keep date/time and field in place for quick multiple entries
      taRenderGames();
    }

    function taUpdateGameScore(gameId, which, value) {
      const g = taState.games.find(g => g.id === gameId);
      if (!g) return;
      const num = value === "" ? null : Number(value);
      if (Number.isNaN(num)) return;
      if (which === "A") g.scoreA = num;
      if (which === "B") g.scoreB = num;
      taSaveState();
    }

    function taDeleteGame(id) {
      taState.games = taState.games.filter(g => g.id !== id);
      taSaveState();
      taRenderGames();
    }

    function taRenderGames() {
      const container = document.getElementById("ta-games-list");
      container.innerHTML = "";
      const poolId = document.getElementById("ta-game-pool").value;
      if (!poolId) {
        const p = document.createElement("p");
        p.className = "small-muted";
        p.textContent = "Create a pool first.";
        container.appendChild(p);
        return;
      }

      const games = taState.games.filter(g => g.poolId === poolId);
      if (games.length === 0) {
        const p = document.createElement("p");
        p.className = "small-muted";
        p.textContent = "No games for this pool yet.";
        container.appendChild(p);
        return;
      }

      games.forEach(g => {
        const teamA = taState.teams.find(t => t.id === g.teamAId);
        const teamB = taState.teams.find(t => t.id === g.teamBId);
        const pool = taState.pools.find(p => p.id === g.poolId);

        const row = document.createElement("div");
        row.className = "game-row";

        const dateStr = g.dateTime
          ? new Date(g.dateTime).toLocaleString([], { dateStyle: "short", timeStyle: "short" })
          : "";

        row.innerHTML = `
          <div class="game-main">
            <div class="game-meta">
              ${(pool && pool.name) || "Pool"}
              ${g.field ? " · " + g.field : ""}
              ${dateStr ? " · " + dateStr : ""}
            </div>
            <div class="game-teams">
              ${(teamA && teamA.name) || "Team A"}
              <span style="color:#6b7280;">vs</span>
              ${(teamB && teamB.name) || "Team B"}
            </div>
          </div>
          <div class="game-scores">
            <input type="number" min="0" step="1"
              value="${g.scoreA ?? ""}"
              onchange="taUpdateGameScore('${g.id}','A', this.value)" />
            <span style="color:#e5e7eb;">-</span>
            <input type="number" min="0" step="1"
              value="${g.scoreB ?? ""}"
              onchange="taUpdateGameScore('${g.id}','B', this.value)" />
          </div>
          <div class="game-actions">
            <button type="button" class="secondary" onclick="taDeleteGame('${g.id}')">Delete</button>
          </div>
        `;
        container.appendChild(row);
      });
    }

    /* ---- CLEAR ALL ---- */
    function taClearAll() {
      if (!confirm("This will clear ALL tournament data stored in the backend (pools, teams, games) for every division. Continue?")) return;

      taState = { pools: [], teams: [], games: [] };
      taSaveState();
      taRenderPools();
      taSyncPoolSelectors();
      taRenderTeams();
      taRenderGames();
    }

    /* ---- INIT ---- */
    async function taInit() {
      await taLoadState();
      taInitDivisionSelect();
      taRenderPools();
      taSyncPoolSelectors();
      taRenderTeams();
      taRenderGames();

      document.getElementById("ta-team-pool").addEventListener("change", () => {
        taRenderTeams();
        taSyncGameTeamSelectors();
      });
      document.getElementById("ta-game-pool").addEventListener("change", () => {
        taSyncGameTeamSelectors();
        taRenderGames();
      });
    }

    (function boot() {
      const unlocked = localStorage.getItem(ADMIN_UNLOCK_KEY) === "true";
      if (unlocked) {
        showAdminUI();
      } else {
        document.getElementById("login-screen").style.display = "block";
      }
      taInit();
    })();
  </script>
</body>
</html>