<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AYSO 10W – 12U Girls Standings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
    }
    .glass {
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(148,163,184,0.25);
    }
    .card {
      background: rgba(15,23,42,0.9);
      border-radius: 0.75rem;
      border: 1px solid rgba(51,65,85,0.7);
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      white-space: nowrap;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header / Nav -->
    <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">
          AYSO Area 10W League Tournament
        </h1>
        <p class="text-sm text-slate-300 mt-1">
          12U Girls &mdash; Live Standings
        </p>
      </div>
      <nav class="flex flex-wrap gap-2 text-xs">
        <a href="index.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          Home
        </a>
        <a href="14u-boys.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          14U Boys
        </a>
        <a href="14u-girls.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          14U Girls
        </a>
        <a href="12u-boys.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          12U Boys
        </a>
        <span class="px-3 py-1.5 rounded-full bg-sky-500 font-semibold">
          12U Girls
        </span>
        <a href="10u-boys.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          10U Boys
        </a>
        <a href="10u-girls.html"
           class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700">
          10U Girls
        </a>
      </nav>
    </header>

    <section class="glass rounded-2xl p-4 mb-4">
      <p class="text-xs text-slate-300">
        Standings are calculated from the official tournament scoring:
        <span class="font-semibold">Win = 6</span>,
        <span class="font-semibold">Tie = 3</span>,
        <span class="font-semibold">Loss = 0</span>,
        <span class="font-semibold">+1 per goal (max 3 per game)</span>,
        <span class="font-semibold">+1 shutout bonus</span>,
        minus any posted deductions.
      </p>
      <p id="status" class="text-xs text-slate-400 mt-1">
        Loading standings…
      </p>
    </section>

    <div id="poolsContainer" class="space-y-4"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxqNaECXvHMOWuecTtPNyMLx-ruXWum7Rofcj7pm4L8wWEKCKsQV7GM7xFhqhrzk4CX6A/exec";
    const DIVISION_ID = "12u-girls";

    const statusEl = document.getElementById("status");
    const poolsContainer = document.getElementById("poolsContainer");

    async function loadState() {
      try {
        statusEl.textContent = "Loading standings…";
        const res = await fetch(API_URL + "?t=" + Date.now());
        const json = await res.json();

        const pools = Array.isArray(json.pools) ? json.pools : [];
        const teams = Array.isArray(json.teams) ? json.teams : [];
        const games = Array.isArray(json.games) ? json.games : [];

        renderDivision(pools, teams, games);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Unable to load standings. Please try again later.";
      }
    }

    function renderDivision(pools, teams, games) {
      const divisionPools = pools.filter(p => p.divisionId === DIVISION_ID);
      const divisionTeams = teams.filter(t => t.divisionId === DIVISION_ID);
      const divisionGames = games.filter(g => g.divisionId === DIVISION_ID);

      if (divisionPools.length === 0) {
        statusEl.textContent = "No pools have been entered yet for this division.";
        poolsContainer.innerHTML = "";
        return;
      }

      statusEl.textContent = "Standings update when the admin saves changes.";

      poolsContainer.innerHTML = "";
      divisionPools.forEach(pool => {
        const poolTeams = divisionTeams.filter(t => t.poolId === pool.id);
        const poolGames = divisionGames.filter(g => g.poolId === pool.id);

        const stats = computeStandings(poolTeams, poolGames);

        const card = document.createElement("section");
        card.className = "card p-4";

        const title = document.createElement("h2");
        title.className = "text-lg font-semibold mb-3";
        title.textContent = pool.name || "Pool";
        card.appendChild(title);

        if (stats.length === 0) {
          const msg = document.createElement("p");
          msg.className = "text-xs text-slate-400";
          msg.textContent = "No results have been entered yet for this pool.";
          card.appendChild(msg);
        } else {
          const wrapper = document.createElement("div");
          wrapper.className = "overflow-x-auto";
          const table = document.createElement("table");

          const thead = document.createElement("thead");
          thead.innerHTML = `
            <tr class="text-[11px] uppercase tracking-wide text-slate-300 border-b border-slate-700">
              <th class="py-2 pr-3 text-left">#</th>
              <th class="py-2 pr-3 text-left">Team</th>
              <th class="py-2 px-2 text-center">GP</th>
              <th class="py-2 px-2 text-center">W</th>
              <th class="py-2 px-2 text-center">T</th>
              <th class="py-2 px-2 text-center">L</th>
              <th class="py-2 px-2 text-center">GF</th>
              <th class="py-2 px-2 text-center">GA</th>
              <th class="py-2 px-2 text-center">GD</th>
              <th class="py-2 px-2 text-center">Pts</th>
              <th class="py-2 px-2 text-center">Ded</th>
              <th class="py-2 px-2 text-center">Total</th>
            </tr>
          `;
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          stats.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.className = index % 2 === 0 ? "text-sm" : "text-sm bg-slate-900/40";

            tr.innerHTML = `
              <td class="py-1.5 pr-3 text-[11px] text-slate-400">${index + 1}</td>
              <td class="py-1.5 pr-3">${row.name}</td>
              <td class="py-1.5 px-2 text-center">${row.played}</td>
              <td class="py-1.5 px-2 text-center">${row.wins}</td>
              <td class="py-1.5 px-2 text-center">${row.ties}</td>
              <td class="py-1.5 px-2 text-center">${row.losses}</td>
              <td class="py-1.5 px-2 text-center">${row.gf}</td>
              <td class="py-1.5 px-2 text-center">${row.ga}</td>
              <td class="py-1.5 px-2 text-center">${row.gd}</td>
              <td class="py-1.5 px-2 text-center">${row.points}</td>
              <td class="py-1.5 px-2 text-center text-rose-300">${row.deductions}</td>
              <td class="py-1.5 px-2 text-center font-semibold">${row.totalPoints}</td>
            `;
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          wrapper.appendChild(table);
          card.appendChild(wrapper);
        }

        poolsContainer.appendChild(card);
      });
    }

    function computeStandings(teams, games) {
      const statsMap = {};

      // Init stats
      teams.forEach(team => {
        statsMap[team.id] = {
          id: team.id,
          name: team.name || "Unnamed Team",
          played: 0,
          wins: 0,
          ties: 0,
          losses: 0,
          gf: 0,
          ga: 0,
          gd: 0,
          points: 0,        // before deductions
          deductions: team.deductions || 0,
          totalPoints: 0
        };
      });

      // Process games with valid scores
      games.forEach(game => {
        const hId = game.homeTeamId;
        const aId = game.awayTeamId;

        if (!hId || !aId) return;
        if (!statsMap[hId] || !statsMap[aId]) return;

        const hg = game.homeGoals;
        const ag = game.awayGoals;

        if (hg == null || ag == null || hg === "" || ag === "") return;

        const homeGoals = Number(hg);
        const awayGoals = Number(ag);

        if (Number.isNaN(homeGoals) || Number.isNaN(awayGoals)) return;

        const home = statsMap[hId];
        const away = statsMap[aId];

        home.played++;
        away.played++;

        home.gf += homeGoals;
        home.ga += awayGoals;
        away.gf += awayGoals;
        away.ga += homeGoals;

        home.gd = home.gf - home.ga;
        away.gd = away.gf - away.ga;

        // Result points
        if (homeGoals > awayGoals) {
          home.wins++;
          away.losses++;
          home.points += 6;
        } else if (homeGoals < awayGoals) {
          away.wins++;
          home.losses++;
          away.points += 6;
        } else {
          home.ties++;
          away.ties++;
          home.points += 3;
          away.points += 3;
        }

        // Goal bonuses (max 3)
        home.points += Math.min(homeGoals, 3);
        away.points += Math.min(awayGoals, 3);

        // Shutout bonus
        if (awayGoals === 0 && homeGoals > 0) {
          home.points += 1;
        }
        if (homeGoals === 0 && awayGoals > 0) {
          away.points += 1;
        }
      });

      // Final totals
      Object.values(statsMap).forEach(t => {
        t.totalPoints = t.points - t.deductions;
      });

      // Sort: total pts, then GD, then GF, then name
      const list = Object.values(statsMap);
      list.sort((a, b) => {
        if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
        if (b.gd !== a.gd) return b.gd - a.gd;
        if (b.gf !== a.gf) return b.gf - a.gf;
        return a.name.localeCompare(b.name);
      });

      return list;
    }

    loadState();
  </script>
</body>
</html>